<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sales History | Karibu Groceries</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Main System Styles -->
    <link rel="stylesheet" href="../css/main.css" />
  </head>
  <body>
    <!-- Dynamic Navbar Placeholder -->
    <div id="navbar-container"></div>

    <!-- PAGE HEADER -->
    <header class="dashboard-header border-bottom">
      <div class="container">
        <h4 class="mb-1 fw-bold">Sales History</h4>
        <p class="page-subtitle mb-0">
          Cash and credit transactions across branches
        </p>
      </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="container py-5">
      <!-- DIRECTOR SUMMARY (READ-ONLY) -->
      <section id="directorSummary" class="mb-5 d-none">
        <div class="row g-4">
          <div class="col-md-6 col-lg-3">
            <div class="summary-card highlight-card">
              <h5>Total Cash Sales</h5>
              <p class="summary-amount" id="totalCash">UGX 0</p>
            </div>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="summary-card info-card">
              <h5>Outstanding Credit</h5>
              <p class="summary-amount" id="totalCredit">UGX 0</p>
            </div>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="summary-card">
              <h5>Total Tonnage Sold</h5>
              <p class="summary-amount" id="totalTonnage">0 KG</p>
            </div>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="summary-card">
              <h5>Total Transactions</h5>
              <p class="summary-amount" id="totalTransactions">0</p>
            </div>
          </div>
        </div>
      </section>

      <!-- SALES TABLE (MANAGER + SALES) -->
      <section id="salesTableSection" class="d-none">
        <!-- ACTION BAR -->
        <div
          class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3"
        >
          <div>
            <h4 class="page-title mb-1">Recorded Sales</h4>
            <p class="text-muted mb-0">
              View, filter, and export sales records
            </p>
          </div>

          <div class="d-flex gap-2 flex-wrap">
            <a href="./cash-sale.html" class="btn btn-outline-success">
              Record Cash Sale
            </a>
            <a href="./credit-sale.html" class="btn btn-outline-warning">
              Record Credit Sale
            </a>
            <button id="exportCsvBtn" class="btn btn-success">
              Export CSV
            </button>
          </div>
        </div>

        <!-- FILTERS -->
        <div class="card mb-4">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label fw-semibold">Branch</label>
                <select class="form-select" id="branchFilter">
                  <option value="">All Branches</option>
                  <option value="maganjo">Maganjo</option>
                  <option value="matugga">Matugga</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label fw-semibold">Sale Type</label>
                <select class="form-select" id="typeFilter">
                  <option value="">All Types</option>
                  <option value="cash">Cash</option>
                  <option value="credit">Credit</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- SALES TABLE -->
        <div class="card table-card">
          <div class="table-header">
            <h4>Sales Records</h4>
            <span id="recordCount" class="table-meta">0 records</span>
          </div>

          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Produce</th>
                  <th>Branch</th>
                  <th class="text-end">KG</th>
                  <th class="text-end">Amount</th>
                  <th>Buyer</th>
                  <th>Agent</th>
                  <th>Type</th>
                </tr>
              </thead>
              <tbody id="salesTableBody"></tbody>
            </table>
          </div>

          <div id="emptyState" class="empty-state d-none">
            <h5 class="mb-1">No sales recorded yet</h5>
            <p class="mb-0">
              Sales transactions will appear here once cash or credit sales are
              recorded.
            </p>
          </div>
        </div>
      </section>
    </main>

    <!-- SCRIPTS -->
    <script src="../js/auth.js"></script>
    <script src="../js/sales/salesHistory.js"></script>

    <!-- Load Navbar -->
    <script>
      fetch("../navbar.html")
        .then((response) => {
          if (!response.ok) {
            console.error(
              "Navbar not found or failed to load:",
              response.status,
            );
            return;
          }
          return response.text();
        })
        .then((data) => {
          document.getElementById("navbar-container").innerHTML = data;

          // Automatically highlight the current page link
          const currentPage = location.pathname.split("/").pop();
          document.querySelectorAll(".nav-links .nav-link").forEach((link) => {
            const linkHref = link.getAttribute("href");
            const linkPage = linkHref.split("/").pop();
            if (linkPage === currentPage || linkHref.endsWith(currentPage)) {
              link.classList.add("active");
            }
          });

          // Initialize profile dropdown functionality
          const profileToggle = document.getElementById("profileToggle");
          const profileDropdown = document.getElementById("profileDropdown");

          if (profileToggle && profileDropdown) {
            profileToggle.addEventListener("click", (e) => {
              e.stopPropagation();
              profileDropdown.classList.toggle("open");
            });

            // Close dropdown when clicking outside
            document.addEventListener("click", () => {
              profileDropdown.classList.remove("open");
            });

            // Prevent dropdown from closing when clicking inside it
            profileDropdown.addEventListener("click", (e) => {
              e.stopPropagation();
            });
          }
        })
        .catch((err) => {
          console.error("Error loading navbar:", err);
        });
    </script>
  </body>
</html>
